# 2026-02-06 - Daily Notes

## City Fix Migration gestartet

**Problem:** 3.298.333 Hotels haben `city: "Unknown"` weil ETG-Dump keine separaten city/country_code Felder hat.

**Lösung:** Script `fix_hotel_cities.py` extrahiert Stadt aus `address.street` (letztes Segment nach Komma).

**Bug gefixed:** Script schrieb nach falschem Index `hotels` statt `hotels_de`/`hotels_en`.

**Status:** Läuft im Hintergrund
```bash
tail -f /tmp/fix_cities.log  # Progress checken
```

**Beispiele der Extraktion:**
- "Vlcie Hrdlo 1/A, Bratislava" → "Bratislava"
- "Mendeleev str., 150/4, Ufa" → "Ufa"
- "Via Pietro Nenni 22, Brescia" → "Brescia"

**Discovery:** `region_id: 0` für ALLE Hotels im ETG Dump → Region-Lookup unmöglich, Street-Parsing war einzige Option.

**Country_code Fix:** Aufgeschoben - bräuchte externe City→Country Mapping-Tabelle.

---

## Frontend ES Module Fix

**Problem:** `Cannot access 'eq' before initialization` Error in Safari
**Ursache:** Variable `let __lastSearchKey` war VOR imports deklariert (ES Module Temporal Dead Zone)
**Fix:** Moved nach imports in `SearchPageClient.tsx`

---

## CORS & SSE Fixes

- **CORS:** `ENVIRONMENT=development` für Tests (erlaubt alle Origins)
- **Nginx SSE:** `proxy_buffering off`, `proxy_cache off`, `proxy_read_timeout 300s`

---

## ETG API Compliance

9 Fixes committed: `9c45d10` "ETG API compliance fixes (from 8 API analyses)"
- Typed structs für alle API responses
- `popularity_score` mit `#[serde(default)]`
- Images Type: `Option<Vec<String>>` (match OpenSearch)
- Hash generation fixes
- Deprecated field annotations

---

## Performance Tuning

- **MAX_CONCURRENT_REQUESTS = 50** (32GB RAM erlaubt's)
- Dubai Search: 534 Hotels in 2 Sekunden

---

## Open Issues

1. **Mobile Safari Region Search** - Nach Frontend-Fix testen
   - ES Module TDZ Error war wahrscheinlich die Ursache
   - Chef muss Hard Refresh machen (Ctrl+Shift+R)

2. **City Fix Script** - Läuft noch (~1.5M Hotels remaining)
   - ETA ~1 Stunde total
   - ~77k Hotels/Minute
