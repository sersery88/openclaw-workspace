# 2026-02-06 - Daily Notes

## City Fix Migration gestartet

**Problem:** 3.298.333 Hotels haben `city: "Unknown"` weil ETG-Dump keine separaten city/country_code Felder hat.

**L√∂sung:** Script `fix_hotel_cities.py` extrahiert Stadt aus `address.street` (letztes Segment nach Komma).

**Bug gefixed:** Script schrieb nach falschem Index `hotels` statt `hotels_de`/`hotels_en`.

**Status:** L√§uft im Hintergrund
```bash
tail -f /tmp/fix_cities.log  # Progress checken
```

**Beispiele der Extraktion:**
- "Vlcie Hrdlo 1/A, Bratislava" ‚Üí "Bratislava"
- "Mendeleev str., 150/4, Ufa" ‚Üí "Ufa"
- "Via Pietro Nenni 22, Brescia" ‚Üí "Brescia"

**Discovery:** `region_id: 0` f√ºr ALLE Hotels im ETG Dump ‚Üí Region-Lookup unm√∂glich, Street-Parsing war einzige Option.

**Country_code Fix:** Aufgeschoben - br√§uchte externe City‚ÜíCountry Mapping-Tabelle.

---

## Frontend ES Module Fix

**Problem:** `Cannot access 'eq' before initialization` Error in Safari
**Ursache:** Variable `let __lastSearchKey` war VOR imports deklariert (ES Module Temporal Dead Zone)
**Fix:** Moved nach imports in `SearchPageClient.tsx`

---

## CORS & SSE Fixes

- **CORS:** `ENVIRONMENT=development` f√ºr Tests (erlaubt alle Origins)
- **Nginx SSE:** `proxy_buffering off`, `proxy_cache off`, `proxy_read_timeout 300s`

---

## ETG API Compliance

9 Fixes committed: `9c45d10` "ETG API compliance fixes (from 8 API analyses)"
- Typed structs f√ºr alle API responses
- `popularity_score` mit `#[serde(default)]`
- Images Type: `Option<Vec<String>>` (match OpenSearch)
- Hash generation fixes
- Deprecated field annotations

---

## Performance Tuning

- **MAX_CONCURRENT_REQUESTS = 50** (32GB RAM erlaubt's)
- Dubai Search: 534 Hotels in 2 Sekunden

---

## Open Issues

1. **`eq` Initialization Error** - Noch nicht gel√∂st!
   - Error: `Cannot access 'eq' before initialization`
   - **NICHT in unserem Code** - aus bundled npm dependency
   - Problematic chunk: `.next/static/chunks/1949bdd2d71d6b2f.js`
   - Grep nach `eq` patterns war leer - Source minified
   - **N√§chster Schritt:** Dependencies pr√ºfen (date-fns, lodash, etc.) oder Source Maps

2. **City Fix Script** - L√§uft noch (~1.5M Hotels remaining)
   - Session: `nimble-ocean` (PID 429127)
   - Check: `tail -f /tmp/fix_cities.log`

---

## CRITICAL LESSON LEARNED üö®

**Falsches Verzeichnis editiert!**
- ‚ùå FALSCH: `/root/.openclaw/workspace/frontend-next`
- ‚úÖ RICHTIG: `/root/ETG-Hotel-IBE/frontend-next`

Das Workspace-Verzeichnis hat NICHTS mit dem Projekt zu tun! Immer explizit `/root/ETG-Hotel-IBE/` verwenden.

---

## Rebuild durchgef√ºhrt

- `.next` folder gel√∂scht
- `npm run build` erfolgreich
- BUILD_ID: `ZWjl76Bk9v_yr26L3Zfxm`
- PM2: `pm2 restart hotel-frontend`
- **Chef muss Hard Refresh machen** (Ctrl+Shift+R / ‚åò+Shift+R)

---

## City Fix Script ABGESCHLOSSEN (hotels_de)

**Ergebnis:** 1,526,146 Hotels korrigiert, 13,687 unver√§ndert
**Aktuell laufend:** `hotels_en` (PID 463127)

---

## Language Switching Fixes (Nachmittag/Abend)

**Kernproblem:** Deutsches UI wenn Englisch ausgew√§hlt

### Fixes implementiert:
1. **URL language priority:** `searchParams?.language || i18n.language || 'de'`
2. **React Query cache keys mit language:** Verhindert falsche Sprache aus Cache
3. **Static catalog reload:** Trackt `catalogLanguage` State
4. **German fallback strings:** Alle `t('key', 'fallback')` Fallbacks m√ºssen Englisch sein
5. **Deposit "verf√ºgbar" fix:** Skip availability f√ºr Deposits
6. **Meal type translations:** Overrides f√ºr alle Varianten
7. **Bed type normalization:** `normalizeBedTypeKey()` Funktion
8. **Translation functions:** Expliziter `language` Parameter n√∂tig

### Key Decision:
**Translation functions m√ºssen `language` Parameter erhalten** - `i18n.language` ist beim ersten Render nicht aktualisiert!

---

## Frontend Fixes (Abend)

- **PM2 Restart Loop gefixed:** Process recreated
- **Streaming API re-enabled:** War disabled, verursachte Redis Timeout bei gro√üen Resultaten
- **CSP f√ºr analytics.swissbooker.ch:** Hinzugef√ºgt
- **PulsingDots Component:** F√ºr Loading States
- **Hardcoded "Non-smoking" entfernt:** War nicht √ºbersetzt
- **HTML in Descriptions:** Escaped/stripped

---

## Rust Backend Search Analyse

**Potentieller Bottleneck gefunden:**
```rust
MAX_CONCURRENT_STREAM_REQUESTS: 4  // Sehr konservativ!
```

**Aktuelle Config:**
- `INITIAL_CHUNK_SIZE: 50`
- `REMAINING_CHUNK_SIZE: 100`
- `STREAMING_BATCH_SIZE: 300`
- Claims "ULTRA-FAST PARALLEL SEARCH" mit HTTP/2 multiplexing

**Context7 Research:** tokio async patterns (`tokio::join!`, `tokio::select!`, concurrent streams)

**N√§chster Schritt:** `MAX_CONCURRENT_STREAM_REQUESTS` erh√∂hen auf 16-32 testen

---

## Console Errors (Non-blocking)

- TripAdvisor 404
- Similar Hotels 422
- Sitemap 404

---

## Open Tasks

1. [ ] Monitor hotels_en city fix completion
2. [x] Rust search optimization - DONE (siehe unten)
3. [ ] Test language switching on hotel detail page
4. [ ] Nice-to-have: Similar Hotels 422, TripAdvisor, Sitemap
5. [ ] ETG kontaktieren: Net Commission Model anfragen

---

## Rust Backend Search Optimierung (Mittag)

**Problem:** Batching war ineffizient - mehrere OpenSearch-Calls pro Suche

**L√∂sung implementiert:**
1. **INSTANT LOAD:** 1x ETG API ‚Üí 1x OpenSearch bulk ‚Üí ALLE Hotels auf einmal zur√ºck
2. **Kein Batching mehr:** Vorher 3 Batches (100/500/rest), jetzt 1 Batch (alle)
3. **OpenSearch `_mget`:** Statt `_search` f√ºr ID-lookups (schneller)
4. **Parallel Chunks:** `futures::join_all` f√ºr gro√üe Mengen

**Performance nach Optimierung:**
- ETG API: ~20s (k√∂nnen wir nicht √§ndern)
- OpenSearch bulk: **168ms** (warm) f√ºr ~1000 Hotels
- Total Enrichment: **~200ms**
- Alle 32 Felder werden geladen

---

## ETG API Geschwindigkeitsanalyse

**Direkte curl Tests:**
| Endpoint | Zeit | Hotels | Limit |
|----------|------|--------|-------|
| `/serp/region/` | **23.7s** | 887 | 10/min |
| `/serp/geo/` | **20.4s** | 1859 | 10/min |
| `/serp/hotels/` (50 HIDs) | **2.3s** | 50 | 150/min |

**Fazit:** ETG's Server ist der Bottleneck, nicht unser Code.

---

## ETG Preismodell Discovery

**Problem:** Preise auf RateHawk Portal (1.923 CHF) ‚â† unsere IBE (1.964 CHF)

**Ursache gefunden:** API liefert:
```json
{
  "amount_net": "1964.00",
  "amount_gross": "1964.00", 
  "amount_commission": "0.00"
}
```

**Erkl√§rung:** Account ist im **Gross Model** konfiguriert:
- Gross Model: `amount_net = amount_gross`, keine separate Commission
- Net Commission Model: `amount_net < amount_gross`, Commission sichtbar

**L√∂sung:** ETG Account Manager kontaktieren:
> "Wir m√∂chten auf Net Commission Model wechseln, damit amount_net den echten Einkaufspreis zeigt."

**Doku:** https://docs.emergingtravel.com/docs/b2b-api/hotel-search/retrieve-hotelpage/

---

## hotelpink.ch LIVE! üéâ

**Deployed um 11:19 UTC**
- Nginx von Maintenance auf Live-Proxy umgestellt
- SSL aktiv (Let's Encrypt)
- Frontend: https://hotelpink.ch ‚Üí localhost:3001
- Backend API: https://hotelpink.ch/api/ ‚Üí localhost:8081
- SSE Support konfiguriert

---

## hotelpink.ch UX Improvements (Nachmittag)

### FAQ Page Fix
- **Problem:** FAQ Seite hatte keinen Weg zur√ºck zur Homepage
- **L√∂sung:** Layout-Wrapper hinzugef√ºgt

### Nginx IPv6 Bug
- **Problem:** nginx nutzte `[::1]` (IPv6 localhost), aber Next.js nur auf `127.0.0.1`
- **L√∂sung:** Explizit `127.0.0.1` statt `localhost` in nginx config

### Nginx Performance
- **gzip Compression:** Alle MIME types aktiviert
- **Static Asset Caching:** `/_next/static/` mit 1-Jahr Cache-Control

### Legal Pages erstellt
- `/legal/agb` - Allgemeine Gesch√§ftsbedingungen
- `/legal/impressum` - Impressum & Kontakt
- `/legal/datenschutz` - Datenschutzerkl√§rung
- **Alle bilingual (DE/EN)** mit Language-Switcher
- **Keine tech stack Details** auf public-facing legal pages

### Footer Redesign
- Links zu Legal Pages hinzugef√ºgt
- "Hotels suchen" entfernt
- **Smart Home Link:** Scrollt zu Search-Form auf Homepage, navigiert von anderen Seiten
- **Farbe:** `#1e2533` (zwischen gray-800 und gray-900)

### Account-Seiten Redesign
- **Profile:** Logged-in = Sidebar + Form, Logged-out = Landing mit Benefits
- **My Bookings:** Filter-Tabs, Hotel-Bilder, Voucher-Downloads
- **Favorites:** Grid/List Toggle, bessere Cards, Empty State

### Sitemap Fix
- Von `/sitemap-page` zu `/sitemap` umbenannt
- Layout-Wrapper hinzugef√ºgt

### Text Contrast Fixes (Legal Pages)
- **Problem:** `text-primary-100` war zu dunkel auf Pink-Gradient
- **L√∂sung:** `text-white` und `text-white/70` f√ºr besseren Kontrast
- **Datenschutz:** Hero Card mit explizitem `text-white` und `text-white/90`

### Offen
- [ ] Impressum page evtl. gleiche white-text Fixes n√∂tig
- [ ] Settings page Redesign (√§hnlich Profile/Favorites)

---

## Key Technical Decisions

1. **IPv4 explicit in nginx:** Immer `127.0.0.1` statt `localhost` um IPv6-Probleme zu vermeiden
2. **Smart home link behavior:** `router.push('/')` + `setTimeout` scroll to form
3. **White text on pink gradients:** Opacity-based classes wie `text-primary-100` funktionieren nicht gut auf Gradients ‚Üí explizit `text-white` nutzen
4. **Commission formula:** `net_amount * (1 + commission_rate)` - aber Account ist im Gross Model, daher aktuell kein Aufschlag sichtbar

---

## Still Running

- **hotels_en city fix:** PID 463127, check `tail -f /tmp/fix_cities.log`
