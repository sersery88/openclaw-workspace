# 2026-02-06 - Daily Notes

## City Fix Migration gestartet

**Problem:** 3.298.333 Hotels haben `city: "Unknown"` weil ETG-Dump keine separaten city/country_code Felder hat.

**L√∂sung:** Script `fix_hotel_cities.py` extrahiert Stadt aus `address.street` (letztes Segment nach Komma).

**Bug gefixed:** Script schrieb nach falschem Index `hotels` statt `hotels_de`/`hotels_en`.

**Status:** L√§uft im Hintergrund
```bash
tail -f /tmp/fix_cities.log  # Progress checken
```

**Beispiele der Extraktion:**
- "Vlcie Hrdlo 1/A, Bratislava" ‚Üí "Bratislava"
- "Mendeleev str., 150/4, Ufa" ‚Üí "Ufa"
- "Via Pietro Nenni 22, Brescia" ‚Üí "Brescia"

**Discovery:** `region_id: 0` f√ºr ALLE Hotels im ETG Dump ‚Üí Region-Lookup unm√∂glich, Street-Parsing war einzige Option.

**Country_code Fix:** Aufgeschoben - br√§uchte externe City‚ÜíCountry Mapping-Tabelle.

---

## Frontend ES Module Fix

**Problem:** `Cannot access 'eq' before initialization` Error in Safari
**Ursache:** Variable `let __lastSearchKey` war VOR imports deklariert (ES Module Temporal Dead Zone)
**Fix:** Moved nach imports in `SearchPageClient.tsx`

---

## CORS & SSE Fixes

- **CORS:** `ENVIRONMENT=development` f√ºr Tests (erlaubt alle Origins)
- **Nginx SSE:** `proxy_buffering off`, `proxy_cache off`, `proxy_read_timeout 300s`

---

## ETG API Compliance

9 Fixes committed: `9c45d10` "ETG API compliance fixes (from 8 API analyses)"
- Typed structs f√ºr alle API responses
- `popularity_score` mit `#[serde(default)]`
- Images Type: `Option<Vec<String>>` (match OpenSearch)
- Hash generation fixes
- Deprecated field annotations

---

## Performance Tuning

- **MAX_CONCURRENT_REQUESTS = 50** (32GB RAM erlaubt's)
- Dubai Search: 534 Hotels in 2 Sekunden

---

## Open Issues

1. **`eq` Initialization Error** - Noch nicht gel√∂st!
   - Error: `Cannot access 'eq' before initialization`
   - **NICHT in unserem Code** - aus bundled npm dependency
   - Problematic chunk: `.next/static/chunks/1949bdd2d71d6b2f.js`
   - Grep nach `eq` patterns war leer - Source minified
   - **N√§chster Schritt:** Dependencies pr√ºfen (date-fns, lodash, etc.) oder Source Maps

2. **City Fix Script** - L√§uft noch (~1.5M Hotels remaining)
   - Session: `nimble-ocean` (PID 429127)
   - Check: `tail -f /tmp/fix_cities.log`

---

## CRITICAL LESSON LEARNED üö®

**Falsches Verzeichnis editiert!**
- ‚ùå FALSCH: `/root/.openclaw/workspace/frontend-next`
- ‚úÖ RICHTIG: `/root/ETG-Hotel-IBE/frontend-next`

Das Workspace-Verzeichnis hat NICHTS mit dem Projekt zu tun! Immer explizit `/root/ETG-Hotel-IBE/` verwenden.

---

## Rebuild durchgef√ºhrt

- `.next` folder gel√∂scht
- `npm run build` erfolgreich
- BUILD_ID: `ZWjl76Bk9v_yr26L3Zfxm`
- PM2: `pm2 restart hotel-frontend`
- **Chef muss Hard Refresh machen** (Ctrl+Shift+R / ‚åò+Shift+R)

---

## City Fix Script ABGESCHLOSSEN (hotels_de)

**Ergebnis:** 1,526,146 Hotels korrigiert, 13,687 unver√§ndert
**Aktuell laufend:** `hotels_en` (PID 463127)

---

## Language Switching Fixes (Nachmittag/Abend)

**Kernproblem:** Deutsches UI wenn Englisch ausgew√§hlt

### Fixes implementiert:
1. **URL language priority:** `searchParams?.language || i18n.language || 'de'`
2. **React Query cache keys mit language:** Verhindert falsche Sprache aus Cache
3. **Static catalog reload:** Trackt `catalogLanguage` State
4. **German fallback strings:** Alle `t('key', 'fallback')` Fallbacks m√ºssen Englisch sein
5. **Deposit "verf√ºgbar" fix:** Skip availability f√ºr Deposits
6. **Meal type translations:** Overrides f√ºr alle Varianten
7. **Bed type normalization:** `normalizeBedTypeKey()` Funktion
8. **Translation functions:** Expliziter `language` Parameter n√∂tig

### Key Decision:
**Translation functions m√ºssen `language` Parameter erhalten** - `i18n.language` ist beim ersten Render nicht aktualisiert!

---

## Frontend Fixes (Abend)

- **PM2 Restart Loop gefixed:** Process recreated
- **Streaming API re-enabled:** War disabled, verursachte Redis Timeout bei gro√üen Resultaten
- **CSP f√ºr analytics.swissbooker.ch:** Hinzugef√ºgt
- **PulsingDots Component:** F√ºr Loading States
- **Hardcoded "Non-smoking" entfernt:** War nicht √ºbersetzt
- **HTML in Descriptions:** Escaped/stripped

---

## Rust Backend Search Analyse

**Potentieller Bottleneck gefunden:**
```rust
MAX_CONCURRENT_STREAM_REQUESTS: 4  // Sehr konservativ!
```

**Aktuelle Config:**
- `INITIAL_CHUNK_SIZE: 50`
- `REMAINING_CHUNK_SIZE: 100`
- `STREAMING_BATCH_SIZE: 300`
- Claims "ULTRA-FAST PARALLEL SEARCH" mit HTTP/2 multiplexing

**Context7 Research:** tokio async patterns (`tokio::join!`, `tokio::select!`, concurrent streams)

**N√§chster Schritt:** `MAX_CONCURRENT_STREAM_REQUESTS` erh√∂hen auf 16-32 testen

---

## Console Errors (Non-blocking)

- TripAdvisor 404
- Similar Hotels 422
- Sitemap 404

---

## Open Tasks

1. [ ] Monitor hotels_en city fix completion
2. [ ] Rust search optimization - Test higher concurrency
3. [ ] Test language switching on hotel detail page
4. [ ] Nice-to-have: Similar Hotels 422, TripAdvisor, Sitemap
